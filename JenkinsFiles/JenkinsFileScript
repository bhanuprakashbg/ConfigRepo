properties = null  

def loadProperties() {
    node {
        checkout scm
        properties = new Properties()		
        File propertiesFile = new File("${workspace}/Properties/pipeline.properties")
        properties.load(propertiesFile.newDataInputStream())    
	echo "Immediate one ${properties.appPath}"
    }
}

def notify(status){
    emailext(
        to: "bhanuprakash.bg@gmail.com",
        subject: "${status}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
        body: """<p>${status}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' :</p>
        <p>Check console output at <a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a></p>""",
        
        )
}

node('master'){

	notify('Project Build Started')
	
	stage ('load properties') {
		script {
			loadProperties()				
		}
	}

	stage('Checkout') {
		git "${properties.appPath}"
	}	
	
	stage('Code Analysis') {
		sh 'mvn sonar:sonar'
	}
	
	stage('Build') {    
		sh 'mvn clean install'
	}

	stage ('Artifactory') {
		def server = Artifactory.newServer url:'http://localhost:8081/artifactory', username: 'admin', password: 'password'
		def uploadSpec = """{
		"files": [
            {
            "pattern": "*.war",
            "target": "lib-staging"
            }
		]
		}""" 
		server.upload spec: uploadSpec		
	}
	
	stage('Deploy') {    
		sh 'ls -ltr target/*.war'
		sh 'sudo cp target/*.war /home/devopsuser6/apache-tomcat-8.5.37/webapps'
	}
	
	notify('Project Build Started')
	
}


